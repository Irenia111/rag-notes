# 索引优化 笔记

## 上下文扩展 — “句子窗口检索” 方法

核心思想
- 检索阶段：将文档拆分为单个句子（作为最小文本单元），保证检索准确性。
- 扩展阶段：每个句子节点在 元数据 中存储其前后若干句（即“窗口”），用于生成阶段提供更丰富的上下文。

流程简述
1.	索引构建
使用 SentenceWindowNodeParser 拆分文档成句子节点，同时在每个节点的 metadata 中存入前后 window_size 句的上下文（默认各 3 句）。
2.	检索阶段
系统先针对原始句子文本执行向量检索，精确定位与用户问题最相关的句子节点。
3.	后处理阶段
用 MetadataReplacementPostProcessor 将节点内容替换为包含上下文窗口的文本片段（metadata 中的 “window” 字段）。
4.	Generation 阶段
LLM 接收到带上下文丰富性的文本，有助于生成更连贯、细节丰富的答案。

优点对比
- 句子窗口检索 输出往往更详尽、连贯。例如针对 “AMOC 的担忧” 提问，检索结果不仅涉及趋势，还包括置信度不高、观测时长过短等多个细节维度；而常规检索往往更简要。
- 实际案例（《Life of Pi》中数字 227 的意义）说明，句子窗口检索不仅精确还提供更深层次解读。

## 结构化索引 — 元数据筛选 + 递归检索策略

a) 元数据辅助的过滤策略

为文本块添加结构化元数据（如文件名、章节、年份等），并在检索时先基于元数据进行预筛选，再在筛后的子集上进行向量检索。 
优势：缩小检索范围，提升效率与精确度。例如仅在 “2023 年 Q2 财报” 内容里搜索 “AI 相关论述”。

b) 多源文档递归检索（递归“Routing”检索）

适用于包含多个子知识源（如多工作表的 Excel）的情形：
1.	为每个来源（工作表）生成一个简洁摘要节点；
2.	构建顶层索引用于路由判断；
3.	当问题触发某个摘要节点时，系统再进入对应查询引擎（如 PandasQueryEngine）进行针对性检索；
4.	LLM 生成对应代码执行逻辑并返回答案。

c) 更安全的改进实现建议

由于 PandasQueryEngine 存在安全隐患（比如 eval 执行），建议采用更安全的两步策略：
1.	路由：使用摘要向量索引选择正确知识源；
2.	检索：在内容索引中加入 metadata 过滤，仅在目标源中搜索。
该策略既实现跨源检索能力，又避免执行任意代码的风险。

## 核心对比与总结

优化策略	优势	典型适用场景
- 句子窗口检索	
  - 优势: 精确定位 + 丰富上下文，增强答案质量	
  - 典型适用场景: 长文档专业问答、高细节查询
- 元数据过滤 + 向量检索	
  - 优势: 检索更高效、专注于相关子集	
  - 典型适用场景: 知识库大、关注特定文档属性的情况 
- 递归检索（多源）	
  - 优势: 明确路由至目标来源，保证检索安全、精准	
  - 典型适用场景: 多表格、异构数据源、多领域分类文档场景
- 安全型路由 + 索引	
  - 优势: 同递归检索但更安全，无执行层安全风险	
  - 典型适用场景: 对安全敏感、高风险操作不允许 eval 的场景


## 总结
- 句子窗口检索（Sentence Window Retrieval）：兼顾检索精度与生成质量，很适合复杂问答场景。
- 结构化索引 + 路由机制：提升检索效率，加强针对性，尤其适合大规模、结构化知识库。
- 混合使用：在大规模系统中，这两种策略往往结合使用，实现效率、安全与回答质量的平衡。
